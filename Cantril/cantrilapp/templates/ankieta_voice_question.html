{% extends 'base.html' %}
{% block title %}Pytanie {{ question_number }} / {{ total_questions }}{% endblock %}

{% block content %}
<div class="survey-container">
  <div class="survey-question">
    <div class="survey-progress">Pytanie {{ question_number }} z {{ total_questions }}</div>
    <h2>{{ question }}</h2>
    <div style="width:100%; height:6px; background:#f0f0f0; border-radius:3px; margin-bottom:1rem; overflow:hidden;">
      <div style="width:{{ progress_percent }}%; height:100%; background:#0b5ed7; transition:width 0.3s ease;"></div>
    </div>
  </div>

  <form method="post" enctype="multipart/form-data" id="voice_form" style="background:#fff; padding:1.5rem; border-radius:12px; box-shadow:0 6px 18px rgba(11,94,215,0.06);">
  {% csrf_token %}

  <div style="font-weight:800; margin-bottom:6px;">Wybierz typ odpowiedzi</div>
  <div class="mode-picker-compact" id="mode_picker_compact">
    <details>
      <summary>
        <input class="mode-option-input" type="radio" name="response_type" id="response_audio" value="audio" checked>
        <label for="response_audio" style="cursor:pointer; flex:1;">GÅ‚osowo (nagranie)</label>
      </summary>
      <div class="mode-desc-expand">Nagraj odpowiedÅº mikrofonem. Po nagraniu kliknij â€NastÄ™pne".</div>
    </details>

    <details>
      <summary>
        <input class="mode-option-input" type="radio" name="response_type" id="response_text" value="text">
        <label for="response_text" style="cursor:pointer; flex:1;">Tekstowa</label>
      </summary>
      <div class="mode-desc-expand">Wpisz odpowiedÅº w polu tekstowym. NastÄ™pnie kliknij â€NastÄ™pne".</div>
    </details>
  </div>

  <div id="audio_div" style="display:flex; flex-direction:column; gap:12px;">
    <div style="display:flex; align-items:center; gap:12px; flex-wrap:wrap;">
      <button type="button" id="record_btn" class="btn" style="flex:0 0 auto; padding:0.8rem 1.2rem; min-height:44px; font-size:0.95rem; border-radius:8px; display:flex; align-items:center; gap:0.5rem;">
        ğŸ¤ Start nagrywania
      </button>
      <div id="record_status" style="font-weight:600; color:#374151;">Nie nagrywasz</div>
    </div>
    <div id="audio_preview_wrapper" style="display:none;">
      <p style="margin:0 0 0.5rem 0; font-weight:600; font-size:0.9rem;">Nagranie:</p>
      <audio id="audio_preview" controls style="width:100%; border-radius:6px;"></audio>
      <p style="margin:0.5rem 0 0; font-size:0.85rem; color:#666;">âœ“ Nagranie zostaÅ‚o zapisane. Kliknij â€NastÄ™pne" aby przesÅ‚aÄ‡ odpowiedÅº.</p>
    </div>
    <input type="file" name="audio_file" id="audio_file_input" style="display:none;">
  </div>

  <div id="text_div" style="display:none; margin-top:0.5rem;">
    <textarea name="text_answer" rows="4" style="width:100%; font-size:1rem;"></textarea>
  </div>

  <div class="survey-controls" style="margin-top:1.5rem;">
    <button class="btn" type="submit">NastÄ™pne</button>
  </div>
  </form>
</div>

{% if error %}
  <p style="color:red; margin-top:0.7rem;">{{ error }}</p>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
  // --- Remember response type in localStorage ---
  const lastResponseType = localStorage.getItem('lastResponseType') || 'audio';
  const radioAudio = document.getElementById('response_audio');
  const radioText = document.getElementById('response_text');
  
  // Pre-select the last used response type
  if (lastResponseType === 'text') {
    radioText.checked = true;
    radioAudio.checked = false;
  } else {
    radioAudio.checked = true;
    radioText.checked = false;
  }
  
  // --- Handle radio change and sync details/summary ---
  const audioDiv = document.getElementById('audio_div');
  const textDiv = document.getElementById('text_div');
  const radios = document.querySelectorAll("input[name='response_type']");
  const detailsElements = document.querySelectorAll('.mode-picker-compact details');

  function syncResponseUI() {
    const selected = document.querySelector("input[name='response_type']:checked");
    const value = selected ? selected.value : 'audio';
    
    // Save to localStorage
    localStorage.setItem('lastResponseType', value);
    
    // Update UI
    audioDiv.style.display = value === 'audio' ? 'flex' : 'none';
    textDiv.style.display = value === 'text' ? 'block' : 'none';
    
    // Close all details, open the selected one
    detailsElements.forEach((details, index) => {
      const isAudioDetails = details.querySelector('input[value="audio"]') !== null;
      if ((value === 'audio' && isAudioDetails) || (value === 'text' && !isAudioDetails)) {
        details.open = true;
      } else {
        details.open = false;
      }
    });
  }

  // Sync on radio change
  radios.forEach(r => r.addEventListener('change', syncResponseUI));
  
  // Sync on details open/close (when user clicks summary)
  detailsElements.forEach(details => {
    details.addEventListener('toggle', () => {
      const radio = details.querySelector('input[name="response_type"]');
      if (details.open && radio) {
        radio.checked = true;
        syncResponseUI();
      }
    });
  });
  
  // Initial sync
  // Check if getUserMedia is available; common cause: not using localhost/HTTPS
  if (typeof navigator === 'undefined' || !navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    const msg = 'Twoja przeglÄ…darka nie umoÅ¼liwia dostÄ™pu do mikrofonu z tego adresu. OtwÃ³rz aplikacjÄ™ przez http://127.0.0.1:8000 lub uÅ¼yj HTTPS.';
    console.warn(msg);
    const recordStatusEl = document.getElementById('record_status');
    const recordBtnEl = document.getElementById('record_btn');
    if (recordStatusEl) { recordStatusEl.textContent = msg; recordStatusEl.style.color = '#dc3545'; }
    if (recordBtnEl) { recordBtnEl.disabled = true; recordBtnEl.style.opacity = '0.5'; }
    // Prevent further attempts
  }

  // --- Audio recording with improved UI ---
  let mediaRecorder, audioChunks = [];
  let hasRecording = false;
  const recordBtn = document.getElementById('record_btn');
  const recordStatus = document.getElementById('record_status');
  const audioPreview = document.getElementById('audio_preview');
  const audioPreviewWrapper = document.getElementById('audio_preview_wrapper');
  const audioFileInput = document.getElementById('audio_file_input');
  const form = document.getElementById('voice_form');

  async function startRecording(){
    try{
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];
      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
      mediaRecorder.onstop = e => {
        const blob = new Blob(audioChunks, { type: 'audio/webm' });
        const file = new File([blob], 'response.webm', { type: 'audio/webm' });
        const dt = new DataTransfer();
        dt.items.add(file);
        audioFileInput.files = dt.files;

        audioPreview.src = URL.createObjectURL(blob);
        audioPreviewWrapper.style.display = 'block';
        hasRecording = true;
        
        // Update UI after recording stops
        recordBtn.textContent = 'ğŸ¤ Ponownie nagrywaj';
        recordBtn.classList.remove('recording');
        recordStatus.textContent = 'Zapisano nagranie';
        recordStatus.classList.remove('recording');
        recordStatus.classList.add('saved');
      };
      mediaRecorder.start();
      recordBtn.textContent = 'â¹ï¸ Stop';
      recordBtn.classList.add('recording');
      recordStatus.textContent = 'Nagrywanie...';
      recordStatus.classList.add('recording');
      recordStatus.classList.remove('saved');
    }catch(err){
      console.warn('Brak dostÄ™pu do mikrofonu:', err);
      recordStatus.textContent = 'BÅ‚Ä…d: brak dostÄ™pu do mikrofonu';
      recordStatus.style.color = '#dc3545';
    }
  }

  recordBtn.addEventListener('click', (e) => {
    e.preventDefault();
    if (mediaRecorder && mediaRecorder.state === 'recording'){
      mediaRecorder.stop();
    } else {
      startRecording();
    }
  });

  // stop recording just before form submit to ensure file present
  form.addEventListener('submit', (e) => {
    if (mediaRecorder && mediaRecorder.state === 'recording'){
      e.preventDefault();
      mediaRecorder.stop();
      setTimeout(() => form.submit(), 100);
    }
  });
</script>
{% endblock %}
