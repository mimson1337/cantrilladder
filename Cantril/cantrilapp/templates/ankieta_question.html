{% extends 'base.html' %}
{% block title %}Pytanie {{ question_number }} / {{ total_questions }}{% endblock %}

{% block content %}
<h2 class="center">Pytanie {{ question_number }} / {{ total_questions }}</h2>
<p style="font-size:1.15rem;">{{ question }}</p>

<form method="post" enctype="multipart/form-data" style="margin-top:1rem;">
  {% csrf_token %}

  <!-- Scale only (Cantril) -->
  <!-- Scale -->
  <div id="scale_div">
    <div style="display:flex; justify-content:center;">
      <div id="ladder-visual" style="position:relative; width:160px; height:420px;">
        <div style="position:absolute; left:28px; top:8px; bottom:8px; width:8px; background:#d0daf8; border-radius:4px;"></div>
        <div style="position:absolute; right:28px; top:8px; bottom:8px; width:8px; background:#d0daf8; border-radius:4px;"></div>
        <div id="ladder" aria-label="Skala Cantril 1 do 10" role="radiogroup" style="position:relative; display:flex; flex-direction:column-reverse; gap:10px; align-items:center; justify-content:space-between; height:100%; padding:12px 0;">
          {% for i in scale_range %}
            <button type="button" class="ladder-step" data-value="{{ i }}" aria-checked="false" role="radio" title="{{ i }}" style="width:120px; height:28px; border-radius:6px; background:#fff; border:1px solid #d0daf8; cursor:pointer; text-align:center;">{{ i }}</button>
          {% endfor %}

        </div>
      </div>
    </div>
    <div style="text-align:center; margin-top:0.5rem;">
      <output id="out" style="font-size:1.25rem; font-weight:800;">5</output>
    </div>
    <input id="answer_input" type="hidden" name="answer" value="5">
  </div>

  <!-- No text/audio for Cantril template -->

  <div style="margin-top:1rem; display:flex; gap:0.6rem; justify-content:center;">
    <button class="btn" type="submit">Dalej</button>
  </div>
</form>

{% if error %}
  <p style="color:red; margin-top:0.7rem;">{{ error }}</p>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
  // --- Ladder scale ---
  const ladderButtons = document.querySelectorAll(".ladder-step");
  const out = document.getElementById("out");
  const answerInput = document.getElementById("answer_input");
  ladderButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      ladderButtons.forEach(b => b.style.background="#fff");
      btn.style.background="#d0daf8";
      answerInput.value = btn.dataset.value;
      out.textContent = btn.dataset.value;
    });
  });

  // --- Typ odpowiedzi ---
  const scaleDiv = document.getElementById("scale_div");
  const textDiv = document.getElementById("text_div");
  const audioDiv = document.getElementById("audio_div");
  const radios = document.querySelectorAll("input[name='response_type']");

  radios.forEach(r => {
    r.addEventListener("change", () => {
      scaleDiv.style.display = r.value==="scale" ? "block" : "none";
      textDiv.style.display = r.value==="text" ? "block" : "none";
      audioDiv.style.display = r.value==="audio" ? "block" : "none";
    });
  });

  // --- Nagrywanie audio ---
  let mediaRecorder, audioChunks = [];
  const recordBtn = document.getElementById("record_btn");
  const audioPreview = document.getElementById("audio_preview");
  const audioFileInput = document.getElementById("audio_file_input");

  recordBtn.addEventListener("click", async () => {
    if (mediaRecorder && mediaRecorder.state === "recording") {
      mediaRecorder.stop();
      recordBtn.textContent = "Nagrywaj / Stop";
    } else {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];

      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
      mediaRecorder.onstop = e => {
        const blob = new Blob(audioChunks, { type: "audio/mpeg" });
        const file = new File([blob], "response.mp3", { type: "audio/mpeg" });

        const dt = new DataTransfer();
        dt.items.add(file);
        audioFileInput.files = dt.files;

        audioPreview.src = URL.createObjectURL(blob);
        audioPreview.style.display = "block";
      };

      mediaRecorder.start();
      recordBtn.textContent = "Stop";
    }
  });
</script>
{% endblock %}
