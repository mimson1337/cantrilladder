{% extends 'base.html' %}
{% block title %}Historia ankiet{% endblock %}

{% block content %}
  <div class="back-nav">
    <a class="back-btn" href="{% url 'panel_home' %}">‚Üê Panel</a>
  </div>

  <h2 class="center">Historia wype≈Çnionych ankiet</h2>
  <form method="get" style="max-width:920px; margin:0.5rem auto; display:flex; gap:8px; align-items:center; flex-wrap:wrap; padding:0 1rem; box-sizing:border-box;">
    <input name="q" value="{{ q }}" placeholder="PESEL / nazwa ankiety (np. 2025-12-29)" style="flex:1 1 auto; padding:8px; min-width:80px; box-sizing:border-box;" />
    <button class="btn" type="submit">Szukaj</button>
  </form>

  <div style="max-width:1000px; margin:1rem auto;">
    {% for p in patients %}
      <div class="patient-card">
        <div class="patient-header">
          <div class="patient-info">
            <div class="patient-pesel">
              <a href="{% url 'panel_patient_history' p.id %}" style="color:#0b5ed7; text-decoration:none;">{{ p.pesel }}</a>
            </div>
            {% if p.first_name or p.last_name %}
              <div class="patient-name">{{ p.first_name }} {{ p.last_name }}</div>
            {% endif %}
            <div class="patient-meta">Pacjent</div>
          </div>
          <div style="text-align:right;">
            <div style="font-size:1.5rem; font-weight:800; color:#0b5ed7;">{{ p.surveys|length }}</div>
            <div style="font-size:0.85rem; color:#666;">ankiet(y) wype≈Çnione(e)</div>
          </div>
        </div>

        <div class="survey-items">
          {% for s in p.surveys %}
            <div class="survey-item">
              <div class="survey-item-title">üìã {{ s.survey_label }}</div>
              <div class="survey-item-detail">
                <div class="detail-line">
                  <span class="detail-label">Odpowiedzi</span>
                  <span class="detail-value">{{ s.responses_count }}</span>
                </div>
                <div class="detail-line">
                  <span class="detail-label">Przetworzone</span>
                  <span class="detail-value">{{ s.processed_count }}/{{ s.responses_count }}</span>
                </div>
                <div class="detail-line">
                  <span class="detail-label">Rozpoczƒôta</span>
                  <span class="detail-value">{{ s.first_response_at }}</span>
                </div>
                <div class="detail-line">
                  <span class="detail-label">Zako≈Ñczona</span>
                  <span class="detail-value">{{ s.last_response_at }}</span>
                </div>
              </div>
              <button type="button" class="btn" onclick="location.href='{% url 'panel_results' %}?pesel={{ p.pesel }}&survey_id={{ s.survey_id }}'">PodglƒÖd odpowiedzi ‚Üí</button>
            </div>
          {% empty %}
            <div style="text-align:center; padding:1rem; color:#999;">Brak ankiet</div>
          {% endfor %}
        </div>
      </div>
    {% empty %}
      <div style="text-align:center; padding:2rem; color:#666; background:#f9f9f9; border-radius:8px;">Brak danych do wy≈õwietlenia</div>
    {% endfor %}
  </div>
{% endblock %}
